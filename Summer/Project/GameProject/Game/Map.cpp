#include"Map.h"
#include"Player.h"
#include"Enemy.h"
#include"Boss.h"
static int stage1data[MAP_HEIGHT][MAP_WIDTH] = {
	{ 178,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,182,184,184,184,184,184,184,184,184,184,184,184,184,179},
	{ 176,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,572,572,572,572,572,176,155,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 176,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,588,588,588,588,588,176,163,152,153,153,153,153,153,153,153,153,154,1,176},
	{ 176,1,1,1,1,278,279,1,262,263,569,569,569,569,569,1,1,1,1,1,1,368,369,369,375,370,176,1,160,161,161,161,161,161,161,161,161,162,1,176},
	{ 176,1,1,1,1,286,287,1,270,271,585,585,585,585,585,1,1,1,1,1,1,376,377,377,383,378,176,1,160,161,161,161,161,161,161,161,161,162,1,176},
	{ 176,1,1,1,1,152,153,154,155,1,368,369,369,375,370,1,1,1,1,5,5,5,5,5,5,5,176,1,168,169,169,169,169,169,169,169,169,170,1,176},
	{ 176,1,1,1,1,160,161,162,163,1,376,377,377,383,378,1,1,1,1,5,1,1,1,1,1,1,176,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 176,1,1,1,1,168,169,170,1,1,5,5,5,5,5,5,5,5,5,5,1,1,1,1,1,1,186,180,1,1,188,184,184,184,184,184,184,184,184,190},
	{ 176,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 176,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 176,1,1,1,1,569,569,569,569,569,1,1,571,571,571,571,571,1,1,5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 176,1,1,1,1,585,585,585,585,585,1,1,587,587,587,587,587,1,1,5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 176,1,1,1,1,368,369,369,375,370,1,1,368,369,369,375,370,1,1,5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 176,1,1,1,1,376,377,377,383,378,1,1,376,377,377,383,378,1,1,5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 176,1,1,1,1,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,1,1,569,569,569,569,569,1,1,570,570,570,570,570,1,1,1,1,1,176},
	{ 176,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,5,1,1,585,585,585,585,585,1,1,586,586,586,586,586,1,1,1,1,1,176},
	{ 176,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,5,1,1,368,369,369,375,370,1,1,368,369,369,375,370,1,1,1,1,1,176},
	{ 176,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,230,231,5,1,1,376,377,377,383,378,1,1,376,377,377,383,378,1,1,1,1,1,176},
	{ 176,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,238,239,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,1,1,1,1,1,176},
	{ 176,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 176,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 186,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,187},
};

static int stage2data[MAP_HEIGHT][MAP_WIDTH] = {
	{ 0,10,11,10,11,10,11,10,11,10,11,10,11,10,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{ 10,35,34,35,34,35,34,35,34,35,34,35,34,35,34,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{ 18,34,35,34,35,34,35,34,35,34,35,34,35,34,35,19,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{ 10,35,19,18,19,18,19,18,19,18,19,18,19,18,34,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{ 18,34,11,1,1,1,1,1,1,1,1,1,1,10,35,19,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{ 10,35,19,1,1,1,1,1,1,1,1,1,1,18,34,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{ 18,34,11,1,1,1,1,1,1,1,1,1,1,10,35,19,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{ 10,35,19,1,1,1,1,1,1,1,1,1,1,18,34,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{ 18,34,11,1,1,1,1,1,1,1,1,1,1,10,35,19,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{ 10,35,19,1,1,1,1,1,1,1,1,1,1,18,34,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{ 18,34,11,1,1,1,1,1,1,1,1,1,1,10,35,19,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{ 10,35,19,1,1,1,1,1,1,1,1,1,1,18,34,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{ 18,34,11,1,1,1,1,1,1,1,1,1,1,10,35,19,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 10,35,19,1,1,1,1,1,1,1,1,1,1,18,34,11,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 18,34,11,1,1,1,1,1,1,1,1,1,1,10,35,19,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 10,35,19,1,1,1,1,1,1,1,1,1,1,18,34,11,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,176},
	{ 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{ 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{ 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
};

Map::Map(int stage)
	:Base(eType_Map)
	{

		//画像複製
		m_img = COPY_RESOURCE("Map", CImage);
		switch (stage) {
		case 1:
			
			Base::Add(new Player(CVector2D(200, 300), false));
			//Base::Add(new Enemy(CVector2D(1000, 400), false));
			//Base::Add(new Enemy(CVector2D(600, 500), false));
			//Base::Add(new Enemy(CVector2D(600, 100), false));
			memcpy(m_stagedata, stage1data, sizeof(stage1data));

			break;
		case 2:
			Base::Add(new Player(CVector2D(250, 500), false));
			Base::Add(new Boss(CVector2D(250, 200), false));
			memcpy(m_stagedata, stage2data, sizeof(stage2data));
			break;
		}
	}

	void Map::Draw()
	{
		//マップチップによる表示の繰り返し
		for (int i = 0; i < MAP_HEIGHT; i++) {
			for (int j = 0; j < MAP_WIDTH; j++) {
				//表示しない制御
				if (m_stagedata[i][j] == 0)continue;
				int t = m_stagedata[i][j];
				int x = t % 8;
				int y = t / 8;
				//画像切り抜き
				m_img.SetRect(32 * x, 32 * y, 32 * x + 32, 32 * y + 32);
				//表示サイズ設定
				m_img.SetSize(MAP_TIP_SIZE, MAP_TIP_SIZE);
				//表示位置設定
				m_img.SetPos(MAP_TIP_SIZE * j - m_scroll.x, MAP_TIP_SIZE * i -m_scroll.y);
				//描画
				m_img.Draw();
			}
		}

	}
	int Map::GetTip(const CVector2D& pos)
	{
		//列を計算
		int col = pos.x / MAP_TIP_SIZE;
		//列の制限(0〜MAP_WIDTH-1)
		if (col < 0) col = 0;
		if (col > MAP_WIDTH - 1) col = MAP_WIDTH - 1;
		//行を計算
		int raw = pos.y / MAP_TIP_SIZE;
		//行の制限(0〜MAP_HEIGHT-1)
		if (raw < 0) raw = 0;
		if (raw > MAP_HEIGHT - 1) raw = MAP_HEIGHT - 1;
		//チップデータを返却
		return GetTip(col, raw);
	}

	int Map::GetTip(int col, int raw)
	{
		return m_stagedata[raw][col];
	}

	int Map::CollisionMap(const CVector2D& pos, const CRect& rect)
	{
			//左上
			int t = GetTip(CVector2D(pos.x + rect.m_left, pos.y + rect.m_top));
			if (t >=8) return t;
			//右上
			t = GetTip(CVector2D(pos.x + rect.m_right, pos.y + rect.m_top));
			if (t >=8) return t;
			//左下
			t = GetTip(CVector2D(pos.x + rect.m_left, pos.y + rect.m_bottom));
			if (t >=8) return t;
			//右下
			t = GetTip(CVector2D(pos.x + rect.m_right, pos.y + rect.m_bottom));
			if (t >=8) return t;
			return 0;
		}
	



